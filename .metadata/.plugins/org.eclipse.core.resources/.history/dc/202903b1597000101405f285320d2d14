package com.project.service;

import java.util.ArrayList;
import java.util.List;
import java.util.stream.Collectors;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.project.entity.DelivaryAddress;
import com.project.entity.OrderDetails;
import com.project.entity.PaymentDetails;
import com.project.entity.ProductInfo;
import com.project.repository.DelivaryRepository;
import com.project.repository.OrderRepository;
import com.project.repository.PaymentRepository;
import com.project.repository.ProductRepository;
import com.project.request.OrderDetailsRequest;
import com.project.response.DelivaryAddressResponse;
import com.project.response.OrderDetailsResponse;
import com.project.response.PaymentDetailsResponse;
import com.project.response.ProductInfoResponse;

import jakarta.transaction.Transactional;

@Service
@Transactional
public class OrderService {

	@Autowired
	OrderRepository orderRepository; 
	
	@Autowired
	DelivaryRepository delivaryRepository;
	
	@Autowired
	PaymentRepository paymentRepository;
	
	@Autowired
	ProductRepository productRepository;
	
	
	public String createOrder(OrderDetailsRequest orderDetailsRequest) {
		System.out.println("sevice layer: DTO -> ENTITY"+orderDetailsRequest);
		
		OrderDetails orderDetails = new OrderDetails();
		orderDetails.setName(orderDetailsRequest.getName());
		orderDetails.setEmail(orderDetailsRequest.getEmail());
		orderDetails.setMobile(orderDetailsRequest.getMobile());
		orderDetails.setTotalAmount(orderDetailsRequest.getTotalAmount());
		
		DelivaryAddress delivaryAddress = new DelivaryAddress();
		delivaryAddress.setDStreetName(orderDetailsRequest.getDelivaryAddress().getDStreetName());
		delivaryAddress.setDBuildingName(orderDetailsRequest.getDelivaryAddress().getDBuildingName());
		delivaryAddress.setDFlatNo(orderDetailsRequest.getDelivaryAddress().getDFlatNo());
		delivaryAddress.setDCity(orderDetailsRequest.getDelivaryAddress().getDCity());
		delivaryAddress.setDState(orderDetailsRequest.getDelivaryAddress().getDState());
		delivaryAddress.setDPinCode(orderDetailsRequest.getDelivaryAddress().getDPinCode());
//		orderDetails.setDelivaryAddress(delivaryAddress);
		delivaryRepository.save(delivaryAddress);
		
		PaymentDetails paymentDetails = new PaymentDetails();
		paymentDetails.setPPaidAmount(orderDetailsRequest.getPaymentDetails().getPPaidAmount());
		paymentDetails.setPStatus(orderDetailsRequest.getPaymentDetails().getPStatus());
		paymentDetails.setPBankTransaction(orderDetailsRequest.getPaymentDetails().getPBankTransaction());
//		orderDetails.setPaymentDetails(paymentDetails);
		paymentRepository.save(paymentDetails);
		
		
//		List<ProductInfo> allProducts = orderDetailsRequest
//				.getProductinfo()
//				.stream()
//				.map(p -> new ProductInfo(
//						p.getPProductId(),
//						p.getPName(),
//						p.getPPrice(),
//						p.getPQuantity(),
//						p.getPSpecification())).toList();
//		
//		orderDetails.setProductinfo(allProducts);		
		
		
		 List<ProductInfo> allProducts = orderDetailsRequest
				 	.getProductinfo()
				 	.stream()
		            .map(p -> {
		                ProductInfo product = new ProductInfo();
		                product.setPProductId(p.getPProductId());
		                product.setPName(p.getPName());
		                product.setPPrice(p.getPPrice());
		                product.setPQuantity(p.getPQuantity());
		                product.setPSpecification(p.getPSpecification());
		                return product;
		            })
		            .collect(Collectors.toList());
		        
		 orderDetails.setProductinfo(allProducts);		
		 orderRepository.save(orderDetails);	
		
		 return "Successfully Placed";		
	}


	public List<OrderDetailsResponse> getAllOrder() {
		List<OrderDetails> list = orderRepository.findAll();
		
		List<OrderDetailsResponse> listResponse = new ArrayList<>();
		
		for(OrderDetails details : list) {
			OrderDetailsResponse response = new OrderDetailsResponse();
			response.setName(details.getName());
			response.setEmail(details.getEmail());
			response.setMobile(details.getMobile());
			response.setTotalAmount(details.getTotalAmount());
			
			List<ProductInfoResponse> allProducts = details.getProductinfo()
					 	.stream()
			            .map(p -> {
			            	ProductInfoResponse product = new ProductInfoResponse();
			                product.setPProductId(p.getPProductId());
			                product.setPName(p.getPName());
			                product.setPPrice(p.getPPrice());
			                product.setPQuantity(p.getPQuantity());
			                product.setPSpecification(p.getPSpecification());
			                return product;
			            })
			            .collect(Collectors.toList());
			 response.setProductinfo(allProducts);	
			
			 if (details.getDelivaryAddress() != null) {
			        DelivaryAddressResponse addressResponse = new DelivaryAddressResponse();
			        addressResponse.setDStreetName(details.getDelivaryAddress().getDStreetName());
			        addressResponse.setDCity(details.getDelivaryAddress().getDCity());
			        addressResponse.setDState(details.getDelivaryAddress().getDState());
			        addressResponse.setDZipCode(details.getDelivaryAddress().getDZipCode());
			        response.setDelivaryAddress(addressResponse);
			    }
			
			PaymentDetailsResponse response2 = new PaymentDetailsResponse();
			response2.setPPaidAmount(details.getPaymentDetails().getPPaidAmount());
			response2.setPStatus(details.getPaymentDetails().getPStatus());
			response2.setPBankTransaction(details.getPaymentDetails().getPBankTransaction());
			response.setPaymentDetails(response2);
			
			listResponse.add(response);
		}
		
		return listResponse;
	}

}
