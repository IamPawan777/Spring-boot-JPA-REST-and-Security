package com.project.service;

import java.util.ArrayList;
import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.project.entity.DelivaryAddress;
import com.project.entity.OrderDetails;
import com.project.entity.PaymentDetails;
import com.project.entity.ProductInfo;
import com.project.repository.DelivaryRepository;
import com.project.repository.OrderRepository;
import com.project.repository.PaymentRepository;
import com.project.repository.ProductRepository;
import com.project.request.OrderDetailsRequest;

import jakarta.transaction.Transactional;

@Service
@Transactional
public class OrderService {

	@Autowired
	OrderRepository orderRepository; 
	
	@Autowired
	DelivaryRepository delivaryRepository;
	
	@Autowired
	PaymentRepository paymentRepository;
	
	@Autowired
	ProductRepository productRepository;
	
	
	public String createOrder(OrderDetailsRequest orderDetailsRequest) {
		System.out.println("sevice layer: DTO -> ENTITY"+orderDetailsRequest);
		
		OrderDetails orderDetails = new OrderDetails();
		orderDetails.setName(orderDetailsRequest.getName());
		orderDetails.setEmail(orderDetailsRequest.getEmail());
		orderDetails.setMobile(orderDetailsRequest.getMobile());
		orderDetails.setTotalAmount(orderDetailsRequest.getTotalAmount());
		
		DelivaryAddress delivaryAddress = new DelivaryAddress();
		delivaryAddress.setDStreetName(orderDetailsRequest.getDelivaryAddress().getDStreetName());
		delivaryAddress.setDBuildingName(orderDetailsRequest.getDelivaryAddress().getDBuildingName());
		delivaryAddress.setDFlatNo(orderDetailsRequest.getDelivaryAddress().getDFlatNo());
		delivaryAddress.setDCity(orderDetailsRequest.getDelivaryAddress().getDCity());
		delivaryAddress.setDState(orderDetailsRequest.getDelivaryAddress().getDState());
		delivaryAddress.setDPinCode(orderDetailsRequest.getDelivaryAddress().getDPinCode());
//		orderDetails.setDelivaryAddress(delivaryAddress);
		delivaryRepository.save(delivaryAddress);
		
		PaymentDetails paymentDetails = new PaymentDetails();
		paymentDetails.setPPaidAmount(orderDetailsRequest.getPaymentDetails().getPPaidAmount());
		paymentDetails.setPStatus(orderDetailsRequest.getPaymentDetails().getPStatus());
		paymentDetails.setPBankTransaction(orderDetailsRequest.getPaymentDetails().getPBankTransaction());
//		orderDetails.setPaymentDetails(paymentDetails);
		paymentRepository.save(paymentDetails);
		
		
		List<ProductInfo> allProducts = orderDetailsRequest
				.getProductinfo()
				.stream()
				.map(p -> new ProductInfo(
						p.getPProductId(),
						p.getPName(),
						p.getPPrice(),
						p.getPQuantity(),
						p.getPSpecification())).toList();
		
		orderDetails.setProductinfo(allProducts);
//		paymentRepository.save(allProducts);
		
		
		
		orderRepository.save(orderDetails);	
		
		return "Successfully Placed";
		
	}

}
